<!DOCTYPE html>
<html>
<head>
    <title>NTC Bus API - Complete Endpoint Tester</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .section h3 { margin-top: 0; color: #007bff; }
        .buttons { display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0; }
        button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        button:hover { opacity: 0.8; }
        #results { margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 8px; border-radius: 3px; font-family: monospace; font-size: 13px; }
        .log-success { background: #d4edda; border-left: 4px solid #28a745; }
        .log-error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .log-info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        .log-warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .stats { display: flex; justify-content: space-around; margin: 20px 0; }
        .stat { text-align: center; padding: 10px; background: #e9ecef; border-radius: 5px; }
        .auth-section { background: #fff3cd; border-left: 4px solid #ffc107; }
        .token-display { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; word-break: break-all; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöå NTC Bus API - Complete Endpoint Tester</h1>
            <p>Comprehensive testing for all 26+ endpoints</p>
        </div>

        <div class="stats">
            <div class="stat">
                <div>Total Tests</div>
                <div id="totalTests">0</div>
            </div>
            <div class="stat">
                <div>Passed</div>
                <div id="passedTests" style="color: #28a745;">0</div>
            </div>
            <div class="stat">
                <div>Failed</div>
                <div id="failedTests" style="color: #dc3545;">0</div>
            </div>
            <div class="stat">
                <div>Success Rate</div>
                <div id="successRate">0%</div>
            </div>
        </div>

        <!-- Health Check -->
        <div class="section">
            <h3>üè• Health Check</h3>
            <div class="buttons">
                <button class="btn-primary" onclick="testHealth()">Test Health Endpoint</button>
            </div>
        </div>

        <!-- Public Endpoints -->
        <div class="section">
            <h3>üåê Public Endpoints</h3>
            <div class="buttons">
                <button class="btn-success" onclick="testBuses()">Get All Buses</button>
                <button class="btn-success" onclick="testRoutes()">Get All Routes</button>
                <button class="btn-success" onclick="testSpecificBus()">Get Specific Bus</button>
                <button class="btn-success" onclick="testSpecificRoute()">Get Specific Route</button>
                <button class="btn-success" onclick="testBusLocation()">Get Bus Location</button>
                <button class="btn-success" onclick="testRouteSchedule()">Get Route Schedule</button>
            </div>
        </div>

        <!-- Authentication -->
        <div class="section auth-section">
            <h3>üîê Authentication</h3>
            <div class="buttons">
                <button class="btn-warning" onclick="testRegister()">Register User</button>
                <button class="btn-warning" onclick="testLogin()">Admin Login</button>
                <button class="btn-warning" onclick="testProfile()">Get Profile</button>
                <button class="btn-warning" onclick="testChangePassword()">Change Password</button>
                <button class="btn-warning" onclick="testRefreshToken()">Refresh Token</button>
            </div>
            <div id="tokenDisplay" class="token-display" style="display: none;">
                <strong>Auth Token:</strong><br>
                <span id="tokenText"></span>
            </div>
        </div>

        <!-- Admin Endpoints -->
        <div class="section">
            <h3>üëë Admin Endpoints</h3>
            <h4>User Management</h4>
            <div class="buttons">
                <button class="btn-danger" onclick="testAdminStats()">Dashboard Stats</button>
                <button class="btn-danger" onclick="testAdminUsers()">List Users</button>
                <button class="btn-danger" onclick="testCreateUser()">Create User</button>
            </div>
            <h4>Bus Management</h4>
            <div class="buttons">
                <button class="btn-danger" onclick="testCreateBus()">Create Bus</button>
            </div>
            <h4>Route Management</h4>
            <div class="buttons">
                <button class="btn-danger" onclick="testCreateRoute()">Create Route</button>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="section">
            <h3>üß™ Test Controls</h3>
            <div class="buttons">
                <button class="btn-primary" onclick="runAllTests()">üöÄ Run All Tests</button>
                <button class="btn-secondary" onclick="clearResults()">üóëÔ∏è Clear Results</button>
            </div>
        </div>

        <div id="results">
            <p><strong>Test Results:</strong></p>
            <p>Click "Run All Tests" or individual test buttons to begin...</p>
        </div>
    </div>

    <script>
        const baseUrl = 'http://localhost:5000';
        let authToken = '';
        let testStats = { total: 0, passed: 0, failed: 0 };

        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
            const rate = testStats.total > 0 ? ((testStats.passed / testStats.total) * 100).toFixed(1) : 0;
            document.getElementById('successRate').textContent = rate + '%';
        }

        function log(message, type = 'info', details = '') {
            const timestamp = new Date().toLocaleTimeString();
            const resultsDiv = document.getElementById('results');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
            if (details) logEntry.innerHTML += `<br><small>${details}</small>`;
            resultsDiv.appendChild(logEntry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;

            // Update stats
            if (type === 'success') {
                testStats.passed++;
                testStats.total++;
            } else if (type === 'error') {
                testStats.failed++;
                testStats.total++;
            }
            updateStats();
        }

        function showToken(token) {
            authToken = token;
            document.getElementById('tokenText').textContent = token;
            document.getElementById('tokenDisplay').style.display = 'block';
        }

        async function makeRequest(endpoint, options = {}) {
            try {
                const url = `${baseUrl}${endpoint}`;
                const response = await fetch(url, {
                    method: options.method || 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` }),
                        ...options.headers
                    },
                    ...(options.body && { body: JSON.stringify(options.body) })
                });

                const data = await response.json();
                return { status: response.status, data, ok: response.ok };
            } catch (error) {
                throw new Error(`Request failed: ${error.message}`);
            }
        }

        // Test functions
        async function testHealth() {
            try {
                const result = await makeRequest('/health');
                if (result.ok) {
                    log('‚úÖ Health Check', 'success', `Server status: ${result.data.status}`);
                } else {
                    log('‚ùå Health Check Failed', 'error', `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Health Check Failed', 'error', error.message);
            }
        }

        async function testBuses() {
            try {
                const result = await makeRequest('/buses');
                if (result.ok) {
                    log('‚úÖ Get All Buses', 'success', `Found ${result.data.length} buses`);
                } else {
                    log('‚ùå Get All Buses Failed', 'error', `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Get All Buses Failed', 'error', error.message);
            }
        }

        async function testRoutes() {
            try {
                const result = await makeRequest('/routes');
                if (result.ok) {
                    log('‚úÖ Get All Routes', 'success', `Found ${result.data.length} routes`);
                } else {
                    log('‚ùå Get All Routes Failed', 'error', `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Get All Routes Failed', 'error', error.message);
            }
        }

        async function testSpecificBus() {
            try {
                const result = await makeRequest('/buses/10101');
                if (result.ok) {
                    log('‚úÖ Get Specific Bus', 'success', `Bus 10101 details loaded`);
                } else {
                    log('‚ùå Get Specific Bus Failed', 'error', `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Get Specific Bus Failed', 'error', error.message);
            }
        }

        async function testSpecificRoute() {
            try {
                const result = await makeRequest('/routes/101');
                if (result.ok) {
                    log('‚úÖ Get Specific Route', 'success', `Route 101 details loaded`);
                } else {
                    log('‚ùå Get Specific Route Failed', 'error', `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Get Specific Route Failed', 'error', error.message);
            }
        }

        async function testBusLocation() {
            try {
                const result = await makeRequest('/buses/10101/location');
                if (result.ok) {
                    log('‚úÖ Get Bus Location', 'success', `Location data retrieved`);
                } else {
                    log('‚ùå Get Bus Location Failed', 'error', `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Get Bus Location Failed', 'error', error.message);
            }
        }

        async function testRouteSchedule() {
            try {
                const result = await makeRequest('/routes/101/schedule');
                if (result.ok) {
                    log('‚úÖ Get Route Schedule', 'success', `Schedule data retrieved`);
                } else {
                    log('‚ùå Get Route Schedule Failed', 'error', `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Get Route Schedule Failed', 'error', error.message);
            }
        }

        async function testRegister() {
            try {
                const testUser = {
                    name: 'Test User',
                    email: `test${Date.now()}@example.com`,
                    password: 'testpass123',
                    role: 'user'
                };
                
                const result = await makeRequest('/auth/register', {
                    method: 'POST',
                    body: testUser
                });
                
                if (result.status === 201) {
                    log('‚úÖ User Registration', 'success', `User ${testUser.email} registered successfully`);
                } else {
                    log('‚ùå User Registration Failed', 'error', result.data.message || `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå User Registration Failed', 'error', error.message);
            }
        }

        async function testLogin() {
            try {
                const result = await makeRequest('/auth/login', {
                    method: 'POST',
                    body: {
                        email: 'admin@bustrack.com',
                        password: 'admin123456'
                    }
                });
                
                if (result.ok && result.data.token) {
                    showToken(result.data.token);
                    log('‚úÖ Admin Login', 'success', `Token obtained for ${result.data.user.name}`);
                } else {
                    log('‚ùå Admin Login Failed', 'error', result.data.message || `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Admin Login Failed', 'error', error.message);
            }
        }

        async function testProfile() {
            if (!authToken) {
                log('‚ùå Get Profile Failed', 'error', 'No auth token. Login first.');
                return;
            }
            
            try {
                const result = await makeRequest('/auth/profile');
                if (result.ok) {
                    log('‚úÖ Get Profile', 'success', `Profile loaded for ${result.data.user.name} (${result.data.user.role})`);
                } else {
                    log('‚ùå Get Profile Failed', 'error', `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Get Profile Failed', 'error', error.message);
            }
        }

        async function testChangePassword() {
            if (!authToken) {
                log('‚ùå Change Password Failed', 'error', 'No auth token. Login first.');
                return;
            }
            
            try {
                const result = await makeRequest('/auth/change-password', {
                    method: 'PUT',
                    body: {
                        currentPassword: 'admin123456',
                        newPassword: 'admin123456'
                    }
                });
                
                if (result.ok) {
                    log('‚úÖ Change Password', 'success', 'Password changed successfully');
                } else {
                    log('‚ùå Change Password Failed', 'error', result.data.message || `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Change Password Failed', 'error', error.message);
            }
        }

        async function testRefreshToken() {
            if (!authToken) {
                log('‚ùå Refresh Token Failed', 'error', 'No auth token. Login first.');
                return;
            }
            
            try {
                const result = await makeRequest('/auth/refresh', { method: 'POST' });
                if (result.ok && result.data.token) {
                    showToken(result.data.token);
                    log('‚úÖ Refresh Token', 'success', 'New token obtained');
                } else {
                    log('‚ùå Refresh Token Failed', 'error', `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Refresh Token Failed', 'error', error.message);
            }
        }

        async function testAdminStats() {
            if (!authToken) {
                log('‚ùå Admin Stats Failed', 'error', 'No auth token. Login first.');
                return;
            }
            
            try {
                const result = await makeRequest('/admin/stats');
                if (result.ok) {
                    const stats = result.data;
                    log('‚úÖ Admin Dashboard Stats', 'success', `Users: ${stats.totalUsers}, Buses: ${stats.totalBuses}, Routes: ${stats.totalRoutes}`);
                } else {
                    log('‚ùå Admin Stats Failed', 'error', `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Admin Stats Failed', 'error', error.message);
            }
        }

        async function testAdminUsers() {
            if (!authToken) {
                log('‚ùå Admin Users Failed', 'error', 'No auth token. Login first.');
                return;
            }
            
            try {
                const result = await makeRequest('/admin/users');
                if (result.ok) {
                    log('‚úÖ Admin List Users', 'success', `Found ${result.data.users.length} users`);
                } else {
                    log('‚ùå Admin Users Failed', 'error', `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Admin Users Failed', 'error', error.message);
            }
        }

        async function testCreateUser() {
            if (!authToken) {
                log('‚ùå Create User Failed', 'error', 'No auth token. Login first.');
                return;
            }
            
            try {
                const newUser = {
                    name: 'Admin Test User',
                    email: `admintest${Date.now()}@example.com`,
                    password: 'admintest123',
                    role: 'user'
                };
                
                const result = await makeRequest('/admin/users', {
                    method: 'POST',
                    body: newUser
                });
                
                if (result.status === 201) {
                    log('‚úÖ Admin Create User', 'success', `User ${newUser.email} created by admin`);
                } else {
                    log('‚ùå Create User Failed', 'error', result.data.message || `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Create User Failed', 'error', error.message);
            }
        }

        async function testCreateBus() {
            if (!authToken) {
                log('‚ùå Create Bus Failed', 'error', 'No auth token. Login first.');
                return;
            }
            
            try {
                const newBus = {
                    bus_id: Math.floor(Date.now() / 1000),
                    route_id: 101,
                    capacity: 50,
                    type: 'normal',
                    status: 'On Time'
                };
                
                const result = await makeRequest('/admin/buses', {
                    method: 'POST',
                    body: newBus
                });
                
                if (result.status === 201) {
                    log('‚úÖ Admin Create Bus', 'success', `Bus ${newBus.bus_id} created successfully`);
                } else {
                    log('‚ùå Create Bus Failed', 'error', result.data.message || `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Create Bus Failed', 'error', error.message);
            }
        }

        async function testCreateRoute() {
            if (!authToken) {
                log('‚ùå Create Route Failed', 'error', 'No auth token. Login first.');
                return;
            }
            
            try {
                const newRoute = {
                    route_id: Math.floor(Date.now() / 1000) + 1000,
                    name: 'Test Route ' + Date.now()
                };
                
                const result = await makeRequest('/admin/routes', {
                    method: 'POST',
                    body: newRoute
                });
                
                if (result.status === 201) {
                    log('‚úÖ Admin Create Route', 'success', `Route ${newRoute.route_id} created successfully`);
                } else {
                    log('‚ùå Create Route Failed', 'error', result.data.message || `Status: ${result.status}`);
                }
            } catch (error) {
                log('‚ùå Create Route Failed', 'error', error.message);
            }
        }

        async function runAllTests() {
            log('üöÄ Starting comprehensive API tests...', 'info');
            
            testStats = { total: 0, passed: 0, failed: 0 };
            updateStats();
            
            await testHealth();
            await new Promise(resolve => setTimeout(resolve, 300));
            
            await testBuses();
            await testRoutes();
            await testSpecificBus();
            await testSpecificRoute();
            await testBusLocation();
            await testRouteSchedule();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testLogin();
            await new Promise(resolve => setTimeout(resolve, 300));
            await testProfile();
            await testRefreshToken();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAdminStats();
            await testAdminUsers();
            await testCreateUser();
            await testCreateBus();
            await testCreateRoute();
            
            log('üéâ All tests completed!', 'success', `Final stats: ${testStats.passed}/${testStats.total} passed`);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '<p><strong>Test Results:</strong></p><p>Results cleared. Ready for new tests...</p>';
            testStats = { total: 0, passed: 0, failed: 0 };
            updateStats();
        }

        window.onload = function() {
            log('üåê API Endpoint Tester loaded', 'info', 'Server: ' + baseUrl);
        };
    </script>
</body>
</html>